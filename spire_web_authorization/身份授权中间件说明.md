# 身份授权中间件

身份授权中间件用于控制用户对API和资源的访问权限，是 Web 应用安全开发的核心能力。

## 快速启动

只需 4 步即可集成授权服务：

```cangjie
import spire_web_hosting.*
import spire_web_http.*
import spire_web_authorization.*

main() {
    // 1. 构建Web主机 //[!code highlight]
    let builder = WebHost.createBuilder()
    // 2. 注册授权服务 //[!code highlight]
    builder.services.addAuthorization()
    let host = builder.build()

    // 3. 启用授权中间件 //[!code highlight]
    host.useAuthorization()
    // 4. 启动主机 //[!code highlight]
    host.run()
}
```

:::tip 添加依赖
需要在依赖配置文件(cjpm.toml)中添加如下依赖：

```bash
[dependencies]
  spire_web_http = { path = "/spire_web_http"}
  spire_web_hosting = { path = "/spire_web_hosting"}
  spire_web_authorization = { path = "/spire_web_authorization"}
  spire_extensions_injection = { path = "/spire_extensions_injection"}
```
:::

## 授权策略配置

支持基于角色、策略等多种授权方式：

```cangjie
builder.services.addAuthorization().addPolicy("admin", policy => {
    policy.requireRole("admin")
})

host.useEndpoints { endpoints =>
    endpoints.mapGet("admin", [Authorize("admin")], context => {
        context.response.write("admin only")
    })
}
```

## 授权中间件配置

可自定义授权失败响应、策略扩展等高级选项：

```cangjie
builder.services.addAuthorization().addPolicy("vip", policy => {
    policy.requireClaim("vip", "true")
})
```

## 目录结构建议

```bash
项目根目录/
├─ src/
│  ├─ main.cj
│  └─ ...
├─ cjpm.toml
└─ ...
```
> [!TIP] 权限管理
> 权限模型建议与业务解耦，便于维护和扩展。

## 最佳实践

- 授权中间件应在路由和终结点注册之前。
- 合理设计权限模型，避免过度授权。
- 授权失败应返回 403 Forbidden，便于前端识别。
- 细粒度授权可提升系统安全性。

---

通过集成授权中间件，可实现灵活、可维护的权限控制体系。
