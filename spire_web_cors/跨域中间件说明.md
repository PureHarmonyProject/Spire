# 跨域处理（CORS）中间件

CORS（跨域资源共享）中间件用于允许或限制前端应用从不同源访问后端API，是 Web 应用开发中不可或缺的基础能力。

## 快速启动

只需 4 步即可启用跨域支持：

```cangjie
import spire_web_hosting.*
import spire_web_http.*
import spire_web_cors.*

main() {
    // 1. 构建Web主机 //[!code highlight]
    let builder = WebHost.createBuilder()
    // 2. 注册CORS服务 //[!code highlight]
    builder.services.addCors()
    let host = builder.build()

    // 3. 启用CORS中间件 //[!code highlight]
    host.useCors()
    // 4. 启动主机 //[!code highlight]
    host.run()
}
```

:::tip 添加依赖
需要在依赖配置文件(cjpm.toml)中添加如下依赖：

```bash
[dependencies]
  spire_web_http = { path = "/spire_web_http"}
  spire_web_hosting = { path = "/spire_web_hosting"}
  spire_web_cors = { path = "/spire_web_cors"}
  spire_extensions_injection = { path = "/spire_extensions_injection"}
```
:::

## CORS 策略配置

支持自定义允许的来源、方法、头部、凭据等高级选项：

```cangjie
host.useCors { options =>
    options.addPolicy("default", builder => {
        builder.withOrigins("https://example.com", "https://admin.example.com")
        builder.withMethods("GET", "POST")
        builder.withHeaders("Content-Type", "Authorization")
        builder.withExposedHeaders("X-Custom-Header")
        builder.allowCredentials()
    })
}
```

## 七、仅允许本地（127.0.0.1）跨域访问示例

如需仅允许本地开发环境（127.0.0.1）发起跨域请求，可按如下方式配置：

```cangjie
host.useCors { options =>
    options.addPolicy("localOnly", builder => {
        builder.withOrigins("http://127.0.0.1")
        builder.withMethods("GET", "POST")
        builder.withHeaders("*")
    })
}
```

> [!TIP] 说明
> - `withOrigins` 只允许来自 `http://127.0.0.1` 的请求。
> - 可根据实际端口补全为 `http://127.0.0.1:端口`。
> - 生产环境请勿使用 `allowAnyOrigin()`，以防止安全风险。

## 目录结构建议

```bash
项目根目录/
├─ src/
│  ├─ main.cj
│  └─ ...
├─ cjpm.toml
└─ ...
```
> [!TIP] 策略管理
> 可为不同API分配不同CORS策略，建议与前端协同测试。

## 最佳实践

- 生产环境建议严格配置允许的来源和方法，避免 `allowAnyOrigin()` 滥用。
- 若需支持带凭据的跨域（如Cookie），不能使用 `allowAnyOrigin()`，需指定具体域名。
- 推荐将CORS中间件放在认证、授权等中间件之前。
- 如需调试跨域问题，可通过浏览器控制台查看CORS相关报错。

---

通过合理配置CORS中间件，可有效提升API安全性和前后端协作体验。
