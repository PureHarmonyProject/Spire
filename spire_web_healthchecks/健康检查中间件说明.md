# 健康检查中间件

健康检查中间件用于实时监控应用及其依赖（如数据库、缓存、外部服务等）的运行状态，是 Web 应用高可用和自动化运维的基础能力。

## 快速启动

只需 4 步即可集成健康检查服务：

```cangjie
import spire_web_hosting.*
import spire_web_http.*
import spire_web_healthchecks.*

main() {
    // 1. 构建Web主机 //[!code highlight]
    let builder = WebHost.createBuilder()
    // 2. 注册健康检查服务 //[!code highlight]
    builder.services.addHealthChecks()
    let host = builder.build()

    // 3. 启用健康检查中间件 //[!code highlight]
    host.useHealthChecks("/health")
    // 4. 启动主机 //[!code highlight]
    host.run()
}
```

:::tip 添加依赖
需要在依赖配置文件(cjpm.toml)中添加如下依赖：

```bash
[dependencies]
  spire_web_http = { path = "/spire_web_http"}
  spire_web_hosting = { path = "/spire_web_hosting"}
  spire_web_healthchecks = { path = "/spire_web_healthchecks"}
  spire_extensions_injection = { path = "/spire_extensions_injection"}
```
:::

## 健康检查项扩展

支持自定义多种健康检查项（如数据库、Redis、外部API等）：

```cangjie
builder.services.addHealthChecks().addCheck("db", () => {
    // 检查数据库连接
    return HealthCheckResult.healthy()
})
```

## 健康检查中间件配置

可自定义健康检查路径、响应内容等高级选项：

```cangjie
host.useHealthChecks("/ready", options => {
    options.predicate = check => check.tags.contains("ready")
})
```

## 目录结构建议

```bash
项目根目录/
├─ src/
│  ├─ main.cj
│  └─ ...
├─ cjpm.toml
└─ ...
```
> [!TIP] 监控集成
> 健康检查端点建议仅暴露给内部或受控网络，可结合K8s、Prometheus等监控系统自动探活。

## 最佳实践

- 健康检查应覆盖所有关键依赖。
- 合理拆分健康检查项，便于定位问题。
- 生产环境建议关闭健康检查端点的外网访问。
- 可结合告警系统自动通知异常。

---

通过集成健康检查中间件，可大幅提升服务可用性和自动化运维能力。
