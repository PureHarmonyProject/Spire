# Spire 路由中间件说明文档

## 一、什么是路由中间件

路由中间件是 Web 框架中用于将 HTTP 请求分发到对应处理逻辑（终结点）的核心组件。它负责解析请求路径、方法等信息，并根据预定义的路由规则，将请求映射到对应的处理函数或控制器。

在 Spire 框架中，路由中间件通常通过 `useRouting()` 方法注册到主机管道中，配合终结点注册（如 `useEndpoints`）实现完整的请求分发流程。

---

## 二、路由中间件完整流程示例

下面以一个典型的 Spire Web 项目为例，展示路由中间件的完整流程：

```cj
package spire_web_quickstart.example

// import spire_web_http.* // 顶层核心，包含 Endpoint, EndpointRouteBuilder 基础结构
// import spire_web_hosting.*
// import spire_web_routing.*
// import spire_extensions_injection.*

main() {
    // 1. 创建主机构造器
    let builder = WebHost.createBuilder()
    // 2. 注册路由服务
    builder.services.addRouting()

    // 3. 构建主机
    let host = builder.build()

    // 4. 注册终结点（路由规则）
    host.useEndpoints { endpoints: EndpointRouteBuilder =>
        // 注册 GET 路由
        endpoints.mapGet("hello") { context =>
            context.response.write("hello cangjie")
        }
    }

    // 5. 启动主机
    host.run()

    return 0
}
```

---

## 三、流程说明

1. **注册路由服务**  
   `builder.services.addRouting()` 向依赖注入容器注册路由相关服务，为后续路由匹配做准备。

2. **注册路由中间件**  
   `host.useRouting()`（由 `useEndpoints` 自动注册）将路由中间件加入请求管道。该中间件会在每次请求时解析 URL 路径、HTTP 方法，并查找匹配的终结点。

3. **注册终结点**  
   `host.useEndpoints { ... }` 用于注册具体的路由规则和处理逻辑。每个终结点（如 `mapGet("hello")`）定义了请求路径和对应的处理函数。

4. **请求分发**  
   当有 HTTP 请求到达时，路由中间件会遍历所有注册的终结点，查找与请求路径和方法匹配的处理函数，并将请求交由其处理。

5. **响应输出**  
   处理函数通过 `context.response.write(...)` 输出响应内容，最终返回给客户端。

---

## 四、路由中间件在管道中的位置

路由中间件通常应在授权、认证等中间件之后注册，因为它依赖于请求的身份信息进行资源访问控制。例如：

```cj
host.useAuthentication()
host.useRouting()      // 路由中间件
host.useAuthorization()
host.useEndpoints { ... }
```

---

## 五、常见扩展

- **动态路由**：支持参数化路径（如 `/api/{id}`）。
- **控制器路由**：通过 `mapControllers()` 自动注册控制器中的路由。
- **中间件组合**：可与异常处理、日志等中间件组合使用，提升系统健壮性。

---

## 扩展示例

### 1. 动态路由（参数化路径）

```cj
host.useEndpoints { endpoints: EndpointRouteBuilder =>
    // 支持参数化路径 /api/{id}
    endpoints.mapGet("api/{id}") { context =>
        let id = context.request.routeValues["id"]
        context.response.write("ID: " + id)
    }
}
```

**最佳实践**：参数化路由适用于 RESTful API，建议路径参数命名简洁，业务逻辑中做好参数校验。

### 2. 控制器路由

```cj
// 定义控制器
public class UserController {
    [HttpGet("user/{name}")]
    public func getUser(context: HttpContext) {
        let name = context.request.routeValues["name"]
        context.response.write("User: " + name)
    }
}

main() {
    let builder = WebHost.createBuilder()
    builder.services.addControllers()
    let host = builder.build()
    host.useEndpoints { endpoints =>
        endpoints.mapControllers()
    }
    host.run()
}
```

**最佳实践**：控制器推荐用于复杂业务场景，便于分层管理和单元测试。路由特性（如 `[HttpGet]`）应与方法语义一致。

### 3. 中间件组合

```cj
main() {
    let builder = WebHost.createBuilder()
    builder.services.addRouting()
    let host = builder.build()
    // 异常处理中间件
    host.useMiddleware(ErrorHandlerMiddleware)
    // 日志中间件
    host.useMiddleware(RequestLoggerMiddleware)
    // 路由中间件
    host.useRouting()
    host.useEndpoints { endpoints =>
        endpoints.mapGet("test") { context =>
            context.response.write("middleware test")
        }
    }
    host.run()
}
```

**最佳实践**：中间件顺序很重要，建议异常处理在最前，日志紧随其后，路由和授权等中间件按需排列。每个中间件应只关注单一职责。

---

## 七、参考

- [`spire_web_quickstart/src/example/RouteEndpoint.cj`](spire_web_quickstart/src/example/RouteEndpoint.cj )
- [`spire_web_quickstart/src/backup/main.11cj`](spire_web_quickstart/src/backup/main.11cj )

---

如需更复杂的路由功能，可参考 Spire 的控制器和终结点扩展。
